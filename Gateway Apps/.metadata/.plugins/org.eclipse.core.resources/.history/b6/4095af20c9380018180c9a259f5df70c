package org.nandor.spark;

import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.Set;
import java.util.Timer;

import org.apache.spark.SparkConf;
import org.apache.spark.api.java.JavaSparkContext;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import scala.collection.mutable.HashMap;

public class Testing {

	public static JSONObject readJson(String file) {
		JSONParser parser = new JSONParser();
		JSONObject a = new JSONObject();
		try {
			a = (JSONObject) parser.parse(new FileReader(file));
		} catch (IOException | ParseException e) {
			e.printStackTrace();
		}
		return a;
	}

	public static void writeJson(String file, JSONObject json) {
		FileWriter f;
		try {
			f = new FileWriter(file);
			f.write(json.toJSONString());
			f.flush();
			f.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public static void main2(String[] args) {
		// Timer

		Timer timer = new Timer();
		// timer.schedule(Methods.timerTask, 300, 600000);

		// Init
		Fog f = Methods.InitFog(80, 0);// Cluster Count, Cloud Gw Count
		// Fog
		// f=Exporter.readJsonFog(readJson("C:/Users/Nandor/Documents/FogOfThings/Gateway
		// Apps/spark-test/src/main/java/org/nandor/spark/deploy-W.json"));
		// writeJson("C:/Users/Nandor/Documents/FogOfThings/Gateway
		// Apps/spark-test/src/main/java/org/nandor/spark/deploy-W.json",Exporter.writeJsonFog(f));

		// DisplayData(f);
		// Global Optimization
		//Map<String, Float> data = Methods.GAGlobalStuff(f, 60, 1000, true);// Fog,
																			// Generation
																			// Size,
																			// Generation
																			// Cunt

		// Clustering
		long start = System.currentTimeMillis();
		//Methods.displayClsAndRes(f);
		Map<String, Map<String, String>> results = new java.util.HashMap<>();
		/*for (int i = 1; i <=1 ; i++) {
			for (int j = 6; j <=10; j++) {
				start = System.currentTimeMillis();
				if (Methods.Clustering(f, i, j)) {
					// Methods.ResourceAllocation(f);
					Methods.nandorsAlphaResourceAlloc(f);
					//Methods.displayClsAndRes(f);
					results.put("Old-Eps:" + i + "MinPts" + j, Methods.GAClusStuff(f, 20, 40, true));
					System.out.println("Clustering Old Time Elapsed: " + (System.currentTimeMillis() - start) / (float) 1000);
				}else{
					System.out.println("Clustering Old with "+i+" and "+j+" failed!");
					start = System.currentTimeMillis();
				}
			}
		}*/
		for (int i = 5; i <= 5; i++) {
			for (int j = 11; j <= 11; j++) {
				if (Methods.AdvClustering(f, (float)i/(float)10.0, j)) {
					// Methods.ResourceAllocation(f);
					Methods.nandorsAlphaResourceAlloc(f);
					Methods.displayClsAndRes(f);
					results.put("New-Eps:" + (float)i/(float)10.0 + "MinPts" + j, Methods.GAClusStuff(f, 20, 40, true));
					System.out.println("Clustering New Time Elapsed: " + (System.currentTimeMillis() - start) / (float) 1000);
				}else{
					System.out.println("Clustering New  with "+(float)i/(float)10.0+" and "+j+" failed!");
					start = System.currentTimeMillis();
				}
				
			}
		}
		// GA Cluster Stuff
		// Map<String,Float> data2 = Methods.GAClusStuff(f, 60, 200,true);
		System.out.println("All cls GA: " + results);
		//System.out.println("Global GA: " + data);
		System.out.print("Best Clustr GA: ");
		Map<String, String> bestMethod = new java.util.HashMap<>();
		float bestUtil = (float) 0.0;
		String bestConfig = "";
		for (String d : results.keySet()) {
			// System.out.println(results.get(d));
			if (results.get(d) != null) {
				if (Float.parseFloat(results.get(d).get("1.Utility")) > bestUtil) {
					bestUtil = Float.parseFloat(results.get(d).get("1.Utility"));
					bestMethod = results.get(d);
					bestConfig = d;
				}
			}
		}
		System.out.println("Config: "+bestConfig+" Res: "+bestMethod+" AvgUtility: "+(bestUtil/f.getApps().size()));
		/*
		 * //Exhaustive Cluster Stuff start=System.currentTimeMillis();
		 * Methods.ExhaustiveClusStuff(f); System.out.println("Time Elapsed: "
		 * +(System.currentTimeMillis()-start)/(float)1000);
		 * start=System.currentTimeMillis();
		 */

		// writeJson("C:/Users/Nandor/Documents/FogOfThings/Gateway
		// Apps/spark-test/src/main/java/org/nandor/spark/deploy-W.json",Exporter.writeJsonFog(f));
		timer.cancel();
	}

	public static void main3(String[] args) {

		// Init
		//Fog f = Methods.InitFog(1, 0);// Cluster Count, Cloud Gw Count
		//writeJson("C:/Users/Nandor/Documents/FogOfThings/Gateway Apps/spark-test/src/main/java/org/nandor/spark/deploy-W.json",Exporter.writeJsonFog(f));
		Fog f=Exporter.readJsonFog(readJson("C:/Users/Nandor/Documents/FogOfThings/Gateway Apps/spark-test/src/main/java/org/nandor/spark/deploy-W.json"));
		//Methods.Clustering(f, 1, 2);
		AdvancedCls cls = new AdvancedCls(f);
		Clustering clsOld = new Clustering(f);
		System.out.println(cls.getNeighbours(6,(float)0.75,0));
		System.out.println(clsOld.getNeighbours(6,(float)1,0));
		Set<Integer> test = new HashSet<Integer>();
		test.add(1);test.add(2);test.add(3);
		Set<Integer> test2 = new HashSet<Integer>();
		test2.add(4);test2.add(5);
		System.out.println(cls.getNeighbours(6, (float)0.0));
		System.out.println("New");
		System.out.println(cls.distanceToCluster(6,test));
		System.out.println(cls.distanceToCluster(6,test2));
		System.out.println("Old");
		System.out.println(clsOld.distanceToCluster(6,test));
		System.out.println(clsOld.distanceToCluster(6,test2));

	}
	
	public static void main(String[] args) {
		//Fog f=Exporter.readJsonFog(readJson("C:/Users/Nandor/Documents/FogOfThings/Gateway Apps/spark-test/src/main/java/org/nandor/spark/deploy-W.json"));
		Fog f = Methods.InitFog(5, 0);
		//Methods.GAGlobalStuff(f, 40, 200, true);
		Methods.GAGlobal(f, 60, 200, true);
		//Methods.ExhaustiveGlobal(f);
		WeightedCls cls = new WeightedCls(f);
		System.out.println("Corr for App Distance: "+cls.Correlation("Deployment",cls.allAppSimilarities()));
		System.out.println("Corr for Gw Distance: "+cls.Correlation("Deployment",cls.allGwSimilarities()));
		//System.out.println(cls.getAppSimilarities(1, 2));
		//System.out.println(cls.getGwSimilarities(1, 2));
		//System.out.println(cls.allGwSimilarities());
		//System.out.println(cls.nodes);
		/*for (Integer n:cls.nodes.keySet()){
			System.out.println("P:"+n+" = "+cls.dijkstraSearsch(n));
		}*/
	}

}
