package org.nandor.spark;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.hadoop.util.UTF8ByteArrayUtils;

public class WeighTrainer {
		//Maybe Use Hooke-Jeeves Algorithm
		//https://www.siam.org/books/textbooks/fr18_book.pdf
		private int count = 0;
		private float List<prevRes> = new ArrayList<>();
		private int maxStep;
		private double procLim = 0.3;
		Map<String, Double> appWeights = new HashMap<>();
		Map<String, Double> gwWeights = new HashMap<>();

	public  WeighTrainer(int maxStep){
		//Constructor for Class, might be empty, or some constants
		this.maxStep = maxStep;
	}
	
	
	public void correlationResults(Map<String, Double> corrApp, Map<String, Double> corrGw) {
		//Add the correlation results of the attempted tests 
		//System.out.println("Correlations:");
		//System.out.println(corrApp);
		//System.out.println(corrGw);
		//Get Maxes 
		Double appMax = 0.0;
		Double gwMax = 0.0;
		for (String name: corrApp.keySet()){
			if (Math.abs(corrApp.get(name))>appMax){
				appMax = Math.abs(corrApp.get(name));
			}
		}
		for (String name: corrGw.keySet()){
			if (Math.abs(corrGw.get(name))>gwMax){
				gwMax = Math.abs(corrGw.get(name));
			}
		}
		//Apps
		for (String name: corrApp.keySet()){
			if (Math.abs(corrApp.get(name))>appMax*procLim){
				appWeights.put(name, Math.abs(corrApp.get(name)));
			}
		}
		//Gateways
		for (String name: corrGw.keySet()){
			if (Math.abs(corrGw.get(name))>gwMax*procLim){
				gwWeights.put(name, Math.abs(corrGw.get(name)));
			}
		}
		
		//Adjust so that their sum is 1 (why dunno, seems to make sense to me)
		double sum1=0.0;
		for (String name: appWeights.keySet()){
			sum1+=appWeights.get(name);
		}
		for (String name: appWeights.keySet()){
			appWeights.put(name,appWeights.get(name)/sum1);
		}
		double sum2=0.0;
		for (String name: gwWeights.keySet()){
			sum2+=gwWeights.get(name);
		}
		for (String name: gwWeights.keySet()){
			gwWeights.put(name,gwWeights.get(name)/sum2);
		}
	}
	
	public void attemptResult(Float utility) {
		//Insert the value of the solution just attempted
		//System.out.println("Utility:");
		if (utility<prevRes){
			setFailed();
		}else{
			prevRes=utility;
		}
		
	}
	
	public boolean getNextStep(){
		//Empty request for the next step, will be reimplemented
		count++;
		if (count>=maxStep){
			return false;
		}else{
			return true;
		}
	}

	public void setFailed() {
		//Triggered when an attemt failed for one reason or another
		maxStep = count;
	}
	
	public String getChar() {
		////Return Characteristics as a string
		return "Count: "+count;
	}
	
	public void showData(){
		System.out.println("Data:");
		System.out.println(appWeights);
		System.out.println(gwWeights);
	}

	public Map<String, Double> appWeights() {
		return appWeights;
	}

	public Map<String, Double> gwWeights() {
		return gwWeights;
	}
	
	public static void main(String[] args) {
		WeighTrainer w1 = new WeighTrainer(5);
		List<Map<String, Double>> corrApp = new ArrayList<Map<String,Double>>();
		List<Map<String, Double>> corrGw  = new ArrayList<Map<String,Double>>();
		List<Double> util = new ArrayList<Double>();
		//Iteration Nr. 1
		int iter =0;
		corrApp.add(new HashMap());
		corrGw.add(new HashMap());
		util.add(57.29681);
		//App
		corrApp.get(iter).put("Constraints",0.0349);
		corrApp.get(iter).put("RequirementSim",0.002361);
		corrApp.get(iter).put("ResourceShare",0.01075);
		corrApp.get(iter).put("MessageRate",-0.00127);
		corrApp.get(iter).put("UtilityWeights",0.0);
		corrApp.get(iter).put("UnitLoad",-0.0071);
		corrApp.get(iter).put("Distance",-0.07927);
		//GW
		corrGw.get(iter).put("Capabilities",0.0);
		corrGw.get(iter).put("SharedRes",0.15986);
		corrGw.get(iter).put("PerfToULoad",0.0);
		corrGw.get(iter).put("BaseLoad",0.007514);
		corrGw.get(iter).put("CapToULoad",0.003785);
		//Iteration Nr. 2
		iter = 1;
		corrApp.add(new HashMap());
		corrGw.add(new HashMap());
		util.add(57.65052);
		//App
		corrApp.get(iter).put("Constraints",0.01849);
		corrApp.get(iter).put("RequirementSim",0.0059);
		corrApp.get(iter).put("ResourceShare",0.3482);
		corrApp.get(iter).put("MessageRate",0.00137);
		corrApp.get(iter).put("UtilityWeights",0.0);
		corrApp.get(iter).put("UnitLoad",-0.02149);
		corrApp.get(iter).put("Distance",-0.08280);
		//GW
		corrGw.get(iter).put("Capabilities",0.0);
		corrGw.get(iter).put("SharedRes",0.53);
		corrGw.get(iter).put("PerfToULoad",0.0);
		corrGw.get(iter).put("BaseLoad",0.00737);
		corrGw.get(iter).put("CapToULoad",0.0048);
		//Iteration Nr. 3
		iter = 2;
		corrApp.add(new HashMap());
		corrGw.add(new HashMap());
		util.add(57.7019);
		util.add(57.203);
		//App
		corrApp.get(iter).put("Constraints",0.00957);
		corrApp.get(iter).put("RequirementSim",0.01175);
		corrApp.get(iter).put("ResourceShare",0.1392);
		corrApp.get(iter).put("MessageRate",0.00943);
		corrApp.get(iter).put("UtilityWeights",0.0);
		corrApp.get(iter).put("UnitLoad",-0.005983);
		corrApp.get(iter).put("Distance",-0.077426);
		//GW
		corrGw.get(iter).put("Capabilities",0.0);
		corrGw.get(iter).put("SharedRes",0.4290);
		corrGw.get(iter).put("PerfToULoad",0.0);
		corrGw.get(iter).put("BaseLoad",0.0);
		corrGw.get(iter).put("CapToULoad",0.00619);
		int i = 0;
		while (w1.getNextStep()){
			if (i<2){i++;}
			System.out.println("Step: "+w1.getChar());
			w1.correlationResults(corrApp.get(i), corrGw.get(i));
			w1.attemptResult(util.get(i).floatValue());
			w1.showData();
		}
	}

}
