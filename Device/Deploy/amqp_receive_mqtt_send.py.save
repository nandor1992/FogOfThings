
#!/usr/bin/env python
import pika
import time
import paho.mqtt.client as mqtt
import json

credentials = pika.PlainCredentials('admin', 'hunter')
parameters = pika.ConnectionParameters('localhost',5672,'test', credentials)
connection = pika.BlockingConnection(parameters);

channel = connection.channel()

client = mqtt.Client(client_id="test1",clean_session=True);
client.username_pw_set('admin','hunter')
client.connect("10.0.0.133", 1883,60)
    
print(' [*] Waiting for messages. To exit press CTRL+C')

def callback(ch,method,properties,body):
    print("[x] Received %r"%body)
    try:
        try:
            my_json=json.loads('{"payload":'+body+'}')
        except ValueError:
            print "Non json payload"
            my_json=json.loads('{"payload":"'+body+'"}')
        for names in properties.headers:
            temp={names:properties.headers.get(names)}
            my_json.update(temp)
        data=json.dumps(my_json)
        print data
        (result,mid)=client.publish("send/gateway1",payload=data,qos=1)
        print(str(result))
        if(result!=1):
            client.reconnect()
        print(str(mid))
    except ValueError:
        try    
	print "Nor Json or valid string data" 
channel.basic_qos(prefetch_count=1)
channel.basic_consume(callback,queue='mqtt_conn1',no_ack=True)
try:
    channel.start_consuming()
except KeyboardInterrupt:
    print "Keyboard baby"
    client.disconnect()
    connection.close()
    print "Exiting Main Thread"   
